function zeroPad(a,b){return b=b||2,b-=a.toString().length,b>0?new Array(b+(/\./.test(a)?2:1)).join("0")+a:a+""}function formatTime(a,b){return b=b||new Date,HH=b.getHours(),hh=HH,a=replaceAll(a,"{mm}",zeroPad(b.getMinutes(),2)),a=replaceAll(a,"{ss}",zeroPad(b.getSeconds(),2)),mr="am",hh>11?(mr="pm",hh>12&&(hh-=12)):0==hh&&(hh="12"),a=replaceAll(a,"{hh}",zeroPad(hh,2)),a=replaceAll(a,"{HH}",zeroPad(HH,2)),a=replaceAll(a,"{mr}",mr)}var tadpole={};tadpole.VERSION="0.2.6",tadpole.STATE="alpha",function(a){a.fn.tadpole=function(b,c,d){var e=a(window).data("tadpole");return("init"==b||void 0===e)&&(void 0==e&&(e=new tadpole.UI(a(this),c,d,a.browser.mozilla||!1),a(window).resize(function(){e.resize()}),setInterval(function(){e.loop()},12e4),e.build()),a(window).data("tadpole",e)),"init"!=b&&void 0!=b&&(b="jq_"+b,b in e&&e[b](a(this),d)),e}}(jQuery),replaceAll=function(a,b,c){return a.split(b).join(c)},Object.size=function(a){var b,c=0;for(b in a)a.hasOwnProperty(b)&&c++;return c},Object.steal=function(a,b){for(var c in b)(a.hasOwnProperty(c)||b.hasOwnProperty(c))&&(a[c]="object"==typeof a[c]?Object.extend(a[c],b[c]):b[c])},Object.extend=function(a,b){var c={};return Object.steal(c,a),Object.steal(c,b),c},tadpole.UI=function(a,b,c,d){this.client=b,this.options=Object.extend({monitor:["~Monitor",!0]},c||{}),this.mozilla=d,b.settings.agent="tadpole/"+tadpole.VERSION+" "+b.settings.agent,this.LIB="tadpole",this.VERSION=tadpole.VERSION,this.STATE=tadpole.STATE,a.append('<div class="tadpole"></div>'),this.view=a.find(".tadpole"),this.control=null,this.top=null,this.menu=null,this.book=null,this.monitor=null,this.protocol=new tadpole.Protocol},tadpole.UI.prototype.build=function(){this.top=new tadpole.Top(this),this.book=new tadpole.Book(this),this.control=new tadpole.Control(this),this.menu=new tadpole.Menu(this),this.monitor=this.channel_add(this.options.monitor[0],replaceAll(this.options.monitor[0],"~","server:"));var a=this;this.client.bind("pkt",function(b,c){a.packet(b,c)}),this.client.bind("log",function(b,c){a.packet(b,c)}),this.client.bind("ns.create",function(b){a.channel_add(b.chan.namespace,b.chan.raw)})},tadpole.UI.prototype.resize=function(){},tadpole.UI.prototype.loop=function(){},tadpole.UI.prototype.toggle_menu=function(){return this.menu.toggle()},tadpole.UI.prototype.channel_add=function(a,b){var c=this.menu.channel.add(a,b);return this.book.add(a,b,c)},tadpole.UI.prototype.packet=function(a){var b=this,c=this.protocol.log(a);if(c){if(console.log(">>>",a.sns,"|",c.text()),"log"==a.name&&"~current"==a.sns&&(a.ns=b.book.current.raw,a.sns=b.book.current.ns),a.hasOwnProperty("s")&&"0"==a.s)return;a.html=c.html(),b.book.log_message(c,a)}},tadpole.UI.prototype.log=function(a){return this.monitor.log(a)},tadpole.Book=function(a){this.manager=a,this.clist={},this.current=null,this.build()},tadpole.Book.prototype.build=function(){this.manager.view.append('<div class="book"></div>'),this.view=this.manager.view.find("div.book")},tadpole.Book.prototype.channel=function(a){var b=a.toLowerCase();for(var c in this.clist)if(this.clist.hasOwnProperty(c)&&c==b)return this.clist[c];return null},tadpole.Book.prototype.add=function(a,b,c){var d=new tadpole.Channel(a,b,c,this.manager,this);return this.clist[b.toLowerCase()]=d,this.reveal(b),d},tadpole.Book.prototype.reveal=function(a){var b=a.toLowerCase();this.clist.hasOwnProperty(b)&&(this.current&&this.current.hide(),this.current=this.clist[b],this.current.reveal(),this.manager.top.set_label(this.current.ns))},tadpole.Book.prototype.log=function(a){for(ns in this.clist)this.clist[ns].log(a)},tadpole.Book.prototype.log_message=function(a,b){try{a.global?this.log(b.html):a.monitor?this.manager.log(b.html):this.channel(b.ns).log(b.html)}catch(c){try{this.manager.log("Failed to log for",b.sns,b.html)}catch(c){console.log(">> Failed to log message for",b.sns,"::"),console.log(">>",b.html),console.log(c)}}},tadpole.Channel=function(a,b,c,d,e){this.manager=d,this.book=e,this.tab=c,this.ns=a,this.raw=b,this.selector=replaceAll(this.raw,"pchat:","c-pchat-"),this.selector=replaceAll(this.selector,"chat:","c-chat-"),this.selector=replaceAll(this.selector,"server:","c-server-"),this.selector=replaceAll(this.selector,":","-"),this.hidden=!0,this.background=!1,this.build()},tadpole.Channel.prototype.build=function(){this.book.view.append('<div class="channel" id="'+this.selector+'"><ul class="log"></ul></div>'),this.view=this.book.view.find("div.channel#"+this.selector),this.logview=this.view.find("ul.log")},tadpole.Channel.prototype.reveal=function(){this.hidden&&(this.background||(this.view.css({display:"block"}),this.hidden=!1,this.manager.top.set_label(this.ns)))},tadpole.Channel.prototype.hide=function(){this.hidden||(this.view.css({display:"none"}),this.hidden=!0)},tadpole.Channel.prototype.log=function(a){var b=new Date,c=formatTime("{HH}:{mm}:{ss}",b),d=b.getTime();return this.logview.append('<li id="'+d+'"><span class="timestamp">'+c+"</span>"+a+"</li>"),this.logview.find("li#"+d).last()},tadpole.Channel.prototype.join=function(a){this.log('<p class="background"><strong class="event join">** '+a+" joined *</strong></p>")},tadpole.Channel.prototype.part=function(a,b){this.log('<p class="background"><strong class="event part">** '+a+" left *</strong> "+b+"</p>")},tadpole.Channel.prototype.message=function(a,b){var c=this.log('<h2 class="username">'+a+"</h2><p>"+b+"</p>");this.highlight(c,a,b)},tadpole.Channel.prototype.action=function(a,b){var c=this.log('<p><em><strong class="username">* '+a+"</strong> "+b+"</em></p>");this.highlight(c,a,b)},tadpole.Channel.prototype.highlight=function(a,b,c){var d=this.manager.client.settings.username.toLowerCase();b.toLowerCase()!=d&&-1!=c.toLowerCase().indexOf(d)&&a.addClass("highlight")},tadpole.Channel.prototype.kick=function(a,b,c){this.log('<p><em><strong class="event kick">** '+a+" kicked by "+b+" *</strong> "+c+"</em></p>")},tadpole.ChannelMenu=function(a,b){this.manager=a,this.parentview=b,this.build()},tadpole.ChannelMenu.prototype.build=function(){this.overlay=new tadpole.Overlay(this.manager.view,"channelmenu","right"),this.overlay.view.append('<nav class="channels"><ul>  <li><span class="button" id="channelexit">&laquo; Channels</span></li></ul></nav>'),this.view=this.overlay.view.find("nav"),this.ul=this.view.find("ul"),this.button_back=this.ul.find("span#channelexit");var a=this;this.button_back.on("click",function(b){b.preventDefault(),a.hide()})},tadpole.ChannelMenu.prototype.reveal=function(){return this.overlay.reveal(),this.overlay.visible},tadpole.ChannelMenu.prototype.hide=function(){return this.overlay.hide(),this.overlay.visible},tadpole.ChannelMenu.prototype.add=function(a,b){var c=replaceAll(b,"pchat:","c-pchat-");c=replaceAll(c,"chat:","c-chat-"),c=replaceAll(c,"server:","c-server-"),c=replaceAll(c,":","-"),this.ul.append('<li><a id="tab-'+c+'" href="#">'+a+"</a></li>");var d=this,e=this.ul.find("a#tab-"+c);return e.on("click",function(a){a.preventDefault(),d.manager.book.reveal(b),d.manager.menu.toggle()}),e},tadpole.Control=function(a){this.manager=a,this.build()},tadpole.Control.prototype.build=function(){this.manager.view.append('<div class="control"><form><input type="text" class="msg"></input></form></div>'),this.view=this.manager.view.find("div.control"),this.form=this.view.find("form"),this.input=this.view.find("input"),this.input.width(this.view.width()-20);var a=this;this.input.keydown(function(b){return a.keypress(b)}),this.form.submit(function(b){return a.submit(b)})},tadpole.Control.prototype.get_text=function(a){return void 0==a?this.input.val():(this.input.val(a||""),this.input.val())},tadpole.Control.prototype.set_text=function(a){this.input.val(a||"")},tadpole.Control.prototype.submit=function(a){var b=this.get_text();return this.set_text(""),this.handle(a,b),!1},tadpole.Control.prototype.keypress=function(a){var b=a.which||a.keyCode,c=!1;switch(b){case 13:a.shiftKey?this.submit(a):c=!0;break;default:c=!0}c||(a.preventDefault(),a.stopPropagation())},tadpole.Control.prototype.handle=function(a,b){if(""!=b&&this.manager.book.current){var c=!1;"/"!=b[0]&&(c=!0),b=(a.shiftKey?"/npmsg ":"/"==b[0]?"":"/say ")+b,b=b.slice(1);var d=b.split(" "),e=d.shift().toLowerCase(),f=this.manager.book.current.raw,g=f;if(!c&&d[0]){var h=d[0][0];("#"==h||"@"==h)&&d[0].length>1&&(g=this.manager.client.format_ns(d.shift()))}{var i=d.join(" ");this.manager.client.trigger("cmd."+e,{name:"cmd",cmd:e,args:i,target:g,ns:f})}}},tadpole.Menu=function(a){this.manager=a,this.build()},tadpole.Menu.prototype.build=function(){this.overlay=new tadpole.Overlay(this.manager.view,"menu"),this.overlay.view.append('<nav class="menu"><ul>  <li><a class="users" href="#">Users</a></li>  <li><a class="channels" href="#">Channels</a></li>  <li><a class="settings" href="#">Settings</a></li></ul></nav>'),this.view=this.overlay.view.find("nav"),this.button_users=this.view.find(".users"),this.button_channels=this.view.find(".channels"),this.button_settings=this.view.find(".settings");var a=this;this.button_users.on("click",function(b){b.preventDefault(),a.show_users()}),this.button_channels.on("click",function(b){b.preventDefault(),a.show_channels()}),this.button_settings.on("click",function(b){b.preventDefault(),a.show_settings()}),this.channel=new tadpole.ChannelMenu(this.manager,this.overlay.view)},tadpole.Menu.prototype.toggle=function(){return this.overlay.visible?(this.channel.hide(),this.overlay.hide(),this.manager.top.inactive(),this.overlay.visible):(this.overlay.reveal(),this.manager.top.active(),this.overlay.visible)},tadpole.Menu.prototype.hide_quick=function(){this.manager.top.inactive(),this.overlay.hide_quick()},tadpole.Menu.prototype.show_users=function(){},tadpole.Menu.prototype.show_channels=function(){this.channel.reveal()},tadpole.Menu.prototype.show_settings=function(){},tadpole.Overlay=function(a,b,c){this.parentview=a,this.cls=b,this.origin=c||"top",this.visible=!1,this.build()},tadpole.Overlay.prototype.build=function(){this.parentview.append('<div class="overlay '+this.cls+'"></div>'),this.view=this.parentview.find(".overlay."+this.cls);var a=$("body").height();this.view.height(a-95)},tadpole.Overlay.prototype.reveal=function(){if(!this.visible){switch(this.origin){case"top":default:this.view.slideDown()}this.visible=!0}},tadpole.Overlay.prototype.hide=function(){if(this.visible){switch(this.origin){case"top":default:this.view.slideUp()}this.visible=!1}},tadpole.Overlay.prototype.hide_quick=function(){this.view.css({display:"none"}),this.visible=!1},tadpole.Overlay.prototype.remove=function(){this.view.remove()},tadpole.Protocol=function(){this.messages={chatserver:{keys:["version"],template:'<p><strong class="event">** Connected to llama {version} *</strong></p>',global:!0},dAmnServer:{keys:["version"],template:'<p><strong class="event">** Connected to dAmnServer {version} *</strong></p>',global:!0},login:{keys:["username","e","data"],template:'<p><strong class="event">** Login as {username}: "{e}" *</strong></p>',global:!0},join:{keys:["ns","e"],template:'<p><strong class="event">** Join {ns}: "{e}" *</strong></p>',monitor:!0},part:{keys:["ns","e","r"],template:'<p><strong class="event">** Part {ns}: "{e}" * </strong><em>{r}</em></p>',monitor:!0},property:{keys:["ns","p","by","ts","value"],template:'<p><strong class="event">** Got {p} for {ns} *</strong></p>',monitor:!0},recv_msg:{keys:["user","message"],template:'<h2 class="username">{user}</h2><p>{message}</p>'},recv_action:{keys:["s","user","message"],template:'<p><em><strong class="username">* {user}</strong> {message}</em></p>'},recv_join:{keys:["user","s","info"],template:'<p class="background"><strong class="event join">** {user} joined *</strong></p>'},recv_part:{keys:["user","r"],template:'<p class="background"><strong class="event join">** {user} has left *</strong> {r}</p>'},recv_privchg:{keys:["user","s","by","pc"],template:'<p><strong class="event">** {user} has been made a member of {pc} by {by} *</strong></p>'},recv_kicked:{keys:["user","s","by","r"],template:'<p><strong class="event">** {user} has been kicked by {by} * </strong><em>{r}</em></p>'},recv_admin_create:{keys:["p","user","pc","privs"],template:'<p><strong class="event">** Privilege class {pc} has been created by {user} * </strong><em>{privs}</em></p>'},recv_admin_update:{keys:["p","user","pc","privs"],template:'<p><strong class="event">** Privilege class {pc} has been updated by {user} * </strong><em>{privs}</em></p>'},recv_admin_rename:{keys:["p","user","prev","pc"],template:'<p><strong class="event">** Privilege class {prev} has been renamed to {pc} by {user} *</strong></p>'},recv_admin_move:{keys:["p","user","prev","pc","affected"],template:'<p><strong class="event">** All members of {prev} have been moved to {pc} by {user} * </strong><em>{affected} affected user(s)</em></p>'},recv_admin_remove:{keys:["p","user","pc","affected"],template:'<p><strong class="event">** Privilege class {pc} has been removed by {user} * </strong><em>{affected} affected user(s)</em></p>'},recv_admin_show:null,recv_admin_showverbose:null,recv_admin_privclass:{keys:["p","e","command"],template:'<p><strong class="event">** Admin command "{command}" failed * </strong><em>{e}</em></p>'},kicked:{keys:["ns","user","r"],template:'<p><strong class="event">** You have been kicked by {user} * </strong><em>{r}</em></p>'},ping:null,disconnect:{keys:["e"],template:'<p><strong class="event">** You have been disconnected * </strong><em>{e}</em></p>',global:!0},send:{keys:["ns","e"],template:'<p><strong class="event">** Send error: <em>{e}</em></p>'},kick:{keys:["ns","user","e"],template:'<p><strong class="event">** Could not kick {user} * </strong><em>{e}</em></p>'},get:{keys:["ns","p","e"],template:'<p><strong class="event">** Could not get {p} info for {ns} * </strong><em>{e}</em></p>'},set:{keys:["ns","p","e"],template:'<p><strong class="event">** Could not set {p} * </strong><em>{e}</em></p>'},kill:{keys:["ns","e"],template:'<p><strong class="event">** Kill error * </strong><em>{e}</em></p>'},log:{keys:["ns","msg","info"],template:'<p><strong class="event">** {msg} * </strong><em>{info}</em></p>'},unknown:{keys:["ns","packet"],template:'<p><strong class="event">** Received unknown packet in {ns} * </strong><em>{packet}</em></p>',monitor:!0}}},tadpole.Protocol.prototype.extend_messages=function(a){for(var b in a)this.messages.hasOwnProperty(b)&&(this.messages[b]=a[b])},tadpole.Protocol.prototype.log=function(a){var b=this.messages[a.name];return new tadpole.Protocol.LogMessage(a,b)},tadpole.Protocol.LogMessage=function(a,b){b=b||{},this.event=a,this.template=b.template||"",this.keys=b.keys||[],this.monitor=b.monitor||!1,this.global=b.global||!1,this._html=!1,this._text=!1,this._ansi=!1},tadpole.Protocol.LogMessage.prototype.text=function(){return this._text===!1&&(this._text=this.render(0)),this._text},tadpole.Protocol.LogMessage.prototype.html=function(){return this._html===!1&&(this._html=this.render(1)),this._html},tadpole.Protocol.LogMessage.prototype.ansi=function(){return this._ansi===!1&&(this._ansi=this.render(2)),this._ansi},tadpole.Protocol.LogMessage.prototype.render=function(a){void 0===a&&(a=0);var b=this.template,c="";for(var d in this.keys)if(this.keys.hasOwnProperty(d)&&(key=this.keys[d],key instanceof Array&&(key=key[1]),"pkt"!=key&&(c=this.event[key]||"",null!=c))){if(("ns"==key||"sns"==key)&&(key="ns",c=this.event.sns||c),c.hasOwnProperty("_parser"))switch(a){case 1:c=c.html();break;case 2:c=c.ansi();break;case 0:default:c=c.text()}b=replaceAll(b,"{"+key+"}",c)}return b},tadpole.Top=function(a){this.manager=a,this.build()},tadpole.Top.prototype.build=function(){this.manager.view.append('<div class="top"><span class="label">Tadpole</span><span class="control"><a class="menubutton" href="#">+</a></span></div>'),this.view=this.manager.view.find(".top"),this.button=this.view.find(".menubutton"),this.label=this.view.find("span.label");var a=this;this.button.on("click",function(a){a.preventDefault(),console.log("menu button clicked")}),this.view.on("click",function(b){b.preventDefault(),b.stopPropagation(),a.manager.toggle_menu()})},tadpole.Top.prototype.set_label=function(a){this.label.html(a)},tadpole.Top.prototype.active=function(){this.view.hasClass("active")||this.view.addClass("active")},tadpole.Top.prototype.inactive=function(){this.view.hasClass("active")&&this.view.removeClass("active")};