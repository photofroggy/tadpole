function zeroPad(a,b){return b=b||2,b-=a.toString().length,b>0?new Array(b+(/\./.test(a)?2:1)).join("0")+a:a+""}function formatTime(a,b){return b=b||new Date,HH=b.getHours(),hh=HH,a=replaceAll(a,"{mm}",zeroPad(b.getMinutes(),2)),a=replaceAll(a,"{ss}",zeroPad(b.getSeconds(),2)),mr="am",hh>11?(mr="pm",hh>12&&(hh-=12)):0==hh&&(hh="12"),a=replaceAll(a,"{hh}",zeroPad(hh,2)),a=replaceAll(a,"{HH}",zeroPad(HH,2)),a=replaceAll(a,"{mr}",mr)}var tadpole={};tadpole.VERSION="0.19.43",tadpole.STATE="beta",function(a){a.fn.tadpole=function(b,c,d){var e=a(window).data("tadpole");return("init"==b||void 0===e)&&(void 0==e&&(e=new tadpole.UI(a(this),c,d,a.browser.mozilla||!1),a(window).resize(function(){e.resize()}),setInterval(function(){e.loop()},12e4),e.build()),a(window).data("tadpole",e)),"init"!=b&&void 0!=b&&(b="jq_"+b,b in e&&e[b](a(this),d)),e}}(jQuery),replaceAll=function(a,b,c){return a.split(b).join(c)},Object.size=function(a){var b,c=0;for(b in a)a.hasOwnProperty(b)&&c++;return c},Object.steal=function(a,b){for(var c in b)(a.hasOwnProperty(c)||b.hasOwnProperty(c))&&(a[c]="object"==typeof a[c]?Object.extend(a[c],b[c]):b[c])},Object.extend=function(a,b){var c={};return Object.steal(c,a),Object.steal(c,b),c},tadpole.UI=function(a,b,c,d){this.client=b,this.options=Object.extend({monitor:["~Monitor",!0],default_theme:"Blue",themes:{Blue:"theme_blue","DeviantArt Green":"theme_dagr"}},c||{}),this.mozilla=d,b.settings.agent="tadpole/"+tadpole.VERSION+" "+b.settings.agent,this.LIB="tadpole",this.VERSION=tadpole.VERSION,this.STATE=tadpole.STATE,a.append('<div class="tadpole"></div>'),this.view=a.find(".tadpole"),this.control=null,this.top=null,this.menu=null,this.book=null,this.monitor=null,this.lusername=this.client.settings.username.toLowerCase(),this.protocol=new tadpole.Protocol,this.mw=new wsc.Middleware,this.evt=new EventEmitter,this.ext={}},tadpole.UI.prototype.build=function(){this.top=new tadpole.Top(this),this.book=new tadpole.Book(this),this.control=new tadpole.Control(this),this.menu=new tadpole.MainMenu(this),this.monitor=this.channel_add(this.options.monitor[0],replaceAll(this.options.monitor[0],"~","server:"));var a=this;this.client.bind("pkt",function(b,c){a.packet(b,c)}),this.client.bind("log",function(b,c){a.packet(b,c)}),this.client.middle("ns.remove",function(b,c){a.book.remove(b.ns),c(b)}),this.client.bind("ns.create",function(b){a.channel_add(b.chan.namespace,b.chan.raw,b.chan.hidden)}),this.client.bind("ns.user.list",function(b,c){a.book.channel(c.format_ns(b.ns)).users.set_users(b.users)}),this.client.middle("ns.user.privchg",function(b,c){var d=a.book.channel(a.client.format_ns(b.ns)).users,e=a.client.channel(b.ns).info.members[b.user];return d.remove_user(b.user,!0),e?(e=Object.extend(e,{}),e.pc=b.pc,d.set(e),void c(b)):(d.reveal_pcs(),void c(b))}),this.client.bind("ns.user.remove",function(b,c){a.book.channel(c.format_ns(b.ns)).users.register(b.user)}),this.client.bind("ns.user.registered",function(b,c){a.book.channel(c.format_ns(b.ns)).users.register(b.user)}),this.on("ns.log.after",function(b){var c=b.item;if(b.event.hasOwnProperty("user")&&b.event.user.toLowerCase()!=a.lusername){if(("recv_msg"==b.event.name||"recv_action"==b.event.name)&&-1!=b.event.message.toLowerCase().indexOf(a.lusername)){c.addClass("highlight");try{a.book.channel(b.event.ns).highlight()}catch(d){}}var e=b.event.user,f=a.control;c.on("click",function(a){a.preventDefault(),a.stopPropagation();var b=f.get_text();return b.length>0?void f.set_text(b+(" "==b[b.length-1]?"":" ")+e):void f.set_text(e+": ")})}}),this.ext.default=tadpole.Commands(this.client,this)},tadpole.UI.prototype.resize=function(){this.menu.resize(),this.control.resize(),this.book.resize()},tadpole.UI.prototype.loop=function(){},tadpole.UI.prototype.toggle_menu=function(){return this.menu.toggle()},tadpole.UI.prototype.channel_add=function(a,b,c){var d="c-"+replaceAll(b,":","-"),e={tab:this.menu.channel.add(a,b,c),head:this.menu.heads.add(d,c),users:this.menu.users.add(d,c)};return this.book.add(a,b,c,e)},tadpole.UI.prototype.middle=function(a,b){this.mw.add(a,b)},tadpole.UI.prototype.cascade=function(a,b,c){this.mw.run(a,b,c)},tadpole.UI.prototype.on=function(a,b){this.evt.addListener(a,b)},tadpole.UI.prototype.emit=function(a,b){this.evt.emit(a,b,this)},tadpole.UI.prototype.packet=function(a,b){var c=this,d=this.protocol.log(a);if(d){if("log"==a.name&&"~current"==a.sns&&(a.ns=c.book.current.raw,a.sns=c.book.current.ns),a.hasOwnProperty("s")&&"0"==a.s)return void this.book.handle(a,b);if(a.hasOwnProperty("user")&&-1!=b.ext.defaults.ignore.ignored.indexOf(a.user.toLowerCase()))return void this.book.handle(a,b);a.html=d.html(),this.cascade("log_message",function(a){c.book.log_message(a.message,a.event)},{message:d,event:a})}this.book.handle(a,b)},tadpole.UI.prototype.log=function(a){return this.monitor.log(a)},tadpole.Top=function(a){this.manager=a,this.unread=0,this.build()},tadpole.Top.prototype.build=function(){this.manager.view.append('<div class="top"><span class="label">Tadpole</span><span class="control"><span class="button highlights red icon-comment"><span class="count">5</span></span><a class="menubutton icon-menu" href="#"></a></span></div>'),this.view=this.manager.view.find(".top"),this.button=this.view.find(".menubutton"),this.label=this.view.find("span.label"),this.hbox=this.view.find(".highlights"),this.hcount=this.hbox.find(".count");var a=this;this.button.on("click",function(a){a.preventDefault(),console.log("menu button clicked")}),this.view.on("click",function(b){b.preventDefault(),b.stopPropagation(),a.manager.toggle_menu()})},tadpole.Top.prototype.set_label=function(a){this.label.html(a)},tadpole.Top.prototype.active=function(){this.view.hasClass("active")||this.view.addClass("active")},tadpole.Top.prototype.inactive=function(){this.view.hasClass("active")&&this.view.removeClass("active")},tadpole.Top.prototype.tab=function(a){this.unread=this.unread+a,this.notify()},tadpole.Top.prototype.untab=function(a){this.unread=this.unread-a,this.notify()},tadpole.Top.prototype.notify=function(){if(this.unread<=0){var a=this;return void this.hbox.fadeOut(function(){a.hcount.text(a.unread.toString())})}this.hcount.text(this.unread.toString());var b=-15;this.unread>9&&(b=-25),this.hbox.fadeIn(),this.hcount.css({"margin-right":b})},tadpole.Overlay=function(a,b,c,d){this.parentview=a,this.cls=b,this.id=c||null,this.selector=".overlay."+replaceAll(this.cls," ","."),this.origin=d||"top",this.visible=!1,null!=this.id&&(this.selector=this.selector+"#"+this.id),this.build()},tadpole.Overlay.prototype.build=function(){var a="";this.id&&(a=' id="'+this.id+'"'),this.parentview.append('<div class="overlay '+this.cls+'"'+a+"></div>"),this.view=this.parentview.find(this.selector);var b=$(window).height();this.view.height(b-45)},tadpole.Overlay.prototype.resize=function(){var a=$(window).height();this.view.height(a-45)},tadpole.Overlay.prototype.reveal=function(){if(!this.visible){switch(this.origin){case"top":default:this.view.slideDown()}this.visible=!0}},tadpole.Overlay.prototype.hide=function(){if(this.visible){switch(this.origin){case"top":default:this.view.slideUp()}this.visible=!1}},tadpole.Overlay.prototype.hide_quick=function(){this.view.css({display:"none"}),this.visible=!1},tadpole.Overlay.prototype.remove=function(){this.view.remove()},tadpole.OverlayArray=function(a,b,c,d){this.parentview=a,this.cls=b,this.id=c,this.origin=d||"top",this.overlays={}},tadpole.OverlayArray.prototype.add=function(a){this.remove(a);var b=new tadpole.Overlay(this.parentview,this.cls,this.id+"-"+a,this.origin);return this.overlays[a.toLowerCase()]=b,b},tadpole.OverlayArray.prototype.overlay=function(a){try{return this.overlays[a.toLowerCase()]}catch(b){}return null},tadpole.OverlayArray.prototype.each=function(a){for(var b in this.overlays)this.overlays.hasOwnProperty(b)&&a(b,this.overlays[b])},tadpole.OverlayArray.prototype.resize=function(){this.each(function(a,b){b.resize()})},tadpole.OverlayArray.prototype.reveal=function(a){var b=this.overlay(a);null!=b&&b.reveal()},tadpole.OverlayArray.prototype.hide=function(){this.each(function(a,b){b.hide()})},tadpole.OverlayArray.prototype.hide_quick=function(){this.each(function(a,b){b.hide_quick()})},tadpole.OverlayArray.prototype.remove=function(a){var b=this.overlay(a);null!=b&&(b.remove(),delete this.overlays[a.toLowerCase()])},tadpole.OverlayArray.prototype.remove_all=function(){this.each(function(a,b){b.remove(),delete this.overlays[a]})},tadpole.Menu=function(a,b,c){this.manager=a,this.parent=b,this.overlay=null,this.buttons=[],this.cls=c||"",this.build()},tadpole.Menu.prototype.build=function(){var a="menu"+(this.cls?" "+this.cls:"");this.overlay=new tadpole.Overlay(this.parent,a),this.overlay.view.append('<nav class="'+a+'"><ul></ul></nav>'),this.view=this.overlay.view.find("nav"),this.ul=this.view.find("ul")},tadpole.Menu.prototype.add=function(a,b,c,d,e,f){var g=new tadpole.MenuButton(this.ul,a,b,c,d,e,f);return this.buttons.push(g),g},tadpole.Menu.prototype.add_nested=function(a,b,c,d,e,f){var g=new tadpole.NestedMenu(this.manager,this.ul,a,b,c,d,e,f);return this.buttons.push(g),g},tadpole.Menu.prototype.resize=function(){this.overlay.resize()},tadpole.Menu.prototype.toggle=function(){return this.resize(),this.overlay.visible?(this.overlay.hide(),this.overlay.visible):(this.overlay.reveal(),this.overlay.visible)},tadpole.Menu.prototype.reveal=function(){return this.overlay.reveal()},tadpole.Menu.prototype.hide=function(){return this.overlay.hide()},tadpole.Menu.prototype.hide_quick=function(){this.overlay.hide_quick()},tadpole.NestedMenu=function(a,b,c,d,e,f,g,h){this.manager=a,this.parent=b,this.buttons=[],this.label=e,this.callback=f,this.cls=c,this.id=d||"",this.icon=g||"",this.hidden=h||!1,this.button=null,this.view=null,this.ul=null,this.visible=!0,this.build()},tadpole.NestedMenu.prototype.build=function(){var a="",b="",c=".button."+replaceAll(this.cls," ",".");this.icon&&(a='<span class="icon-'+this.icon+'"></span>'),this.id&&(c=c+"#"+this.id,b='id="'+this.id+'" '),this.parent.append("<li"+(this.hidden?' class="hidden"':"")+'><a class="button '+this.cls+'" '+b+'href="#">'+a+this.label+"</a><ul></ul></li>"),this.button=this.parent.find(c),this.view=this.button.parent(),this.ul=this.view.find("ul");var d=this.callback;this.button.on("click",function(a){a.preventDefault(),a.stopPropagation(),d(a)}),this.button.css({width:this.parent.parent().parent().width()-30})},tadpole.NestedMenu.prototype.add=function(a,b,c,d,e,f){var g=new tadpole.MenuButton(this.ul,a,b,c,d,e,f,30);return this.buttons.push(g),g},tadpole.MenuButton=function(a,b,c,d,e,f,g,h){this.parent=a,this.label=d,this.callback=e,this.cls=b,this.id=c||"",this.icon=f||"",this.hidden=g||!1,this.pad=h||0,this.button=null,this.view=null,this.visible=!0,this.build()},tadpole.MenuButton.prototype.build=function(){var a="",b='<span class="icon-'+(this.icon?this.icon:"null")+'"></span>',c=".button."+replaceAll(this.cls," ",".");this.id&&(c=c+"#"+this.id,a='id="'+this.id+'" '),this.parent.append("<li"+(this.hidden?' class="hidden"':"")+'><a class="button '+this.cls+'" '+a+'href="#">'+b+this.label+"</a></li>"),this.button=this.parent.find(c),this.view=this.button.parent();var d=this.callback;this.button.on("click",function(a){a.preventDefault(),a.stopPropagation(),d(a)})},tadpole.MenuButton.prototype.remove=function(){this.view.remove()},tadpole.MenuButton.prototype.highlight=function(){this.view.hasClass("highlight")||this.view.addClass("highlight")},tadpole.MenuButton.prototype.unhighlight=function(){this.view.hasClass("highlight")&&this.view.removeClass("highlight")},tadpole.MainMenu=function(a){this.manager=a,this.menu=null,this.users=null,this.heads=null,this.build()},tadpole.MainMenu.prototype.build=function(){var a=this;this.menu=new tadpole.Menu(this.manager,this.manager.view,"main"),this.button_head=this.menu.add("head","","Title/Topic",function(){a.show_head()},"doc"),this.button_users=this.menu.add("users","","Users",function(){a.show_users()},"user"),this.button_channels=this.menu.add("channels","","Channels",function(){a.show_channels()},"comment"),this.commands=this.menu.add_nested("commands","","Commands",function(){},"plus"),this.button_settings=this.menu.add("settings","","Settings",function(){a.show_settings()},"cog"),this.button_about=this.menu.add("about","","About",function(){a.show_about()},"info-alt"),this.channel=new tadpole.ChannelMenu(this.manager,this.manager.view),this.heads=new tadpole.HeadArray(this.manager,this,this.manager.view,"head","h"),this.users=new tadpole.UsersArray(this.manager,this,this.manager.view,"userlist","u"),this.commanditems=new tadpole.MenuItemArray(this.manager,this,this.manager.view,"command","mcom"),this.settings=new tadpole.SettingsMenu(this.manager,this.manager.view),this.about=new tadpole.Overlay(this.manager.view,"about"),this.about.view.append('<nav><ul><li>  <a href="#" class="button"><span class="icon-left-open"></span>About</a></li></nav><div class="section border">  <p>Currently using wsc '+wsc.VERSION+" and  tadpole "+this.manager.VERSION+'. Tadpole is a mobile GUI for  wsc.</p><p>Tadpole and wsc work using HTML, CSS, and javascript.  </p><p>Created by  <a href="http://photofroggy.deviantart.com">photofroggy</a>.</p></div><div class="section">  <p><strong>Chat Agent:</strong></p>  <p><code>'+this.manager.client.settings.agent+"      </code></p>  <p><strong>User Agent:</strong></p>  <p><code>"+navigator.userAgent+"</code></p></div>");var b=this.about;this.button_about=this.about.view.find("a.button"),this.button_about.on("click",function(a){a.preventDefault(),a.stopPropagation(),b.hide()})},tadpole.MainMenu.prototype.resize=function(){this.menu.resize(),this.channel.resize(),this.heads.resize(),this.users.resize(),this.commanditems.resize(),this.settings.resize()},tadpole.MainMenu.prototype.back=function(){if(this.channel.menu.overlay.visible)return void this.channel.hide();var a=!1,b=function(b,c){c.overlay.visible&&(c.overlay.hide(),c.hide(),a=!0)};return this.heads.each(b),a||(this.users.each(b),a||(this.settings.page.each(b),a||(this.commanditems.each(b),a)))?void 0:this.settings.menu.overlay.visible?void this.settings.hide():this.about.visible?void this.about.hide():void this.toggle()},tadpole.MainMenu.prototype.toggle=function(){if(this.resize(),this.menu.overlay.visible)return this.channel.hide(),this.heads.hide(),this.users.hide(),this.commanditems.hide(),this.settings.hide(),this.about.hide(),this.manager.top.inactive(),this.menu.hide(),this.manager.book.current.unhighlight(),window.onhashchange=function(){},history.back(),this.menu.overlay.visible;history.pushState(null,"","#menu");var a=this;return window.onhashchange=function(){history.pushState(null,"","#menu"),a.back()},this.manager.control.input.blur(),this.manager.top.active(),setTimeout(function(){a.menu.reveal()},500),!0},tadpole.MainMenu.prototype.hide_quick=function(){this.manager.top.inactive(),this.menu.hide_quick()},tadpole.MainMenu.prototype.show_head=function(){this.heads.reveal(this.manager.book.current.selector)},tadpole.MainMenu.prototype.show_users=function(a){this.users.reveal(this.manager.book.current.selector,a)},tadpole.MainMenu.prototype.show_channels=function(){this.channel.reveal()},tadpole.MainMenu.prototype.show_settings=function(){this.settings.reveal()},tadpole.MainMenu.prototype.show_about=function(){this.about.reveal()},tadpole.MenuItem=function(a,b,c,d,e){this.manager=a,this.menu=b,this.id=c,this.overlay=d||null,this.hidden=e||!1,this.build()},tadpole.MenuItem.prototype.build=function(){},tadpole.MenuItem.prototype.resize=function(){},tadpole.MenuItem.prototype.reveal=function(){},tadpole.MenuItem.prototype.hide=function(){},tadpole.MenuItem.prototype.remove=function(){},tadpole.MenuItemArray=function(a,b,c,d,e,f){this.manager=a,this.menu=b,this.parentview=c,this.cls=d,this.id=e,this.origin=f||"top",this.items={},this.overlays=this.create_overlay_array()},tadpole.MenuItemArray.prototype.create_item=function(a,b,c){return new tadpole.MenuItem(this.manager,this.menu,a,b,c)},tadpole.MenuItemArray.prototype.create_overlay_array=function(){return new tadpole.OverlayArray(this.parentview,this.cls,this.id,this.origin)},tadpole.MenuItemArray.prototype.add=function(a,b){this.remove(a);var c=this.overlays.add(a),d=this.create_item(a,c,b);return this.items[a.toLowerCase()]=d,d},tadpole.MenuItemArray.prototype.item=function(a){try{return this.items[a.toLowerCase()]}catch(b){}return null},tadpole.MenuItemArray.prototype.each=function(a){for(var b in this.items)if(this.items.hasOwnProperty(b)&&a(b,this.items[b]))return},tadpole.MenuItemArray.prototype.resize=function(){this.each(function(a,b){b.overlay.resize(),b.resize()})},tadpole.MenuItemArray.prototype.reveal=function(a){var b=this.item(a);b&&(b.overlay.reveal(),b.reveal())},tadpole.MenuItemArray.prototype.hide=function(){this.each(function(a,b){b.overlay.hide(),b.hide()})},tadpole.MenuItemArray.prototype.hide_quick=function(){this.each(function(a,b){b.overlay.hide_quick(),b.hide()})},tadpole.MenuItemArray.prototype.remove=function(a){var b=this.item(a);b&&(this.overlays.remove(a),b.remove(),delete this.items[a.toLowerCase()])},tadpole.MenuItemArray.prototype.remove_all=function(){var a=this;this.each(function(b,c){a.overlays.remove(b),c.remove(),delete a.items[b]})},tadpole.Head=function(a,b,c,d,e){tadpole.MenuItem.call(this,a,b,c,d,e)},tadpole.Head.prototype=new tadpole.MenuItem,tadpole.Head.prototype.constructor=tadpole.MenuItem,tadpole.Head.prototype.build=function(){this.overlay.view.append('<nav><ul><li>  <span class="button" id="headexit"><span class="icon-left-open"></span>Title/Topic</span></li></ul></nav><div class="section border title"></div><div class="section topic"></div>'),this.button_exit=this.overlay.view.find("nav ul li span.button#headexit"),this.view={title:this.overlay.view.find("div.title"),topic:this.overlay.view.find("div.topic")},this.content={title:{data:new wsc.MessageString(""),by:"",ts:0},topic:{data:new wsc.MessageString(""),by:"",ts:0}};var a=this;this.button_exit.on("click",function(b){b.preventDefault(),a.overlay.hide(),a.hide()})},tadpole.Head.prototype.set=function(a,b,c,d){this.view[a].html(b.html()),this.content[a].data=b,this.content[a].by=c,this.content[a].ts=d},tadpole.HeadArray=function(a,b,c,d,e,f){tadpole.MenuItemArray.call(this,a,b,c,d,e,f)},tadpole.HeadArray.prototype=new tadpole.MenuItemArray,tadpole.HeadArray.prototype.constructor=tadpole.HeadArray,tadpole.HeadArray.prototype.create_item=function(a,b,c){return new tadpole.Head(this.manager,this.menu,a,b,c)},tadpole.Users=function(a,b,c,d){this.onselect=null,tadpole.MenuItem.call(this,a,b,c,d)},tadpole.Users.prototype=new tadpole.MenuItem,tadpole.Users.prototype.constructor=tadpole.MenuItem,tadpole.Users.prototype.build=function(){this.users={},this.overlay.view.append('<nav><ul><li>  <span class="button" id="usersexit"><span class="icon-left-open"></span>Users</span></li></ul></nav><div class="list"><nav><ul></ul></nav></div>'),this.view=this.overlay.view.find("div.list"),this.ul=this.view.find("nav ul"),this.button_exit=this.overlay.view.find("nav ul li span.button#usersexit");var a=this;this.button_exit.on("click",function(b){b.preventDefault(),a.overlay.hide(),a.hide()})},tadpole.Users.prototype.reveal=function(a){this.onselect=a||null},tadpole.Users.prototype.reveal_pcs=function(){var a=0,b=0,c=null,d=this;this.ul.find(".pc").each(function(){c=d.ul.find(this),b=c.find("ul li").length,a+=b,c.css("display",0==b?"none":"block")}),this.ul.css("display",0==a?"none":"block")},tadpole.Users.prototype.set_pcs=function(a,b){var c="",d=null;this.ul.html("");for(var e in b)c=a[b[e]],this.ul.append('<li class="pc" id="'+replaceAll(c," ","-")+'">  <span class="button"><span class="icon-user"></span>'+c+"</span>  <ul></ul></li>"),d=this.ul.find("li.pc#"+c),d.css("display","none"),this.users[c]={pc:d,users:d.find("ul")}},tadpole.Users.prototype.set=function(a,b){var c=this.users[a.pc],d=1==a.conn?"":"["+a.conn+"]",e='<li class="user" id="'+a.name+'"><a target="_blank" href="http://'+a.name+"."+this.manager.options.domain+'"><em>'+a.symbol+"</em>"+a.name+d+"</a></li>";c.users.append(e);var f=c.users.find("li.user#"+a.name),g=this.manager.control,h=this;f.find("a").on("click",function(b){b.preventDefault(),(h.onselect||function(a,b){var c=g.get_text();return c.length>0?void g.set_text(c+(" "==c[c.length-1]?"":" ")+b.name):void g.set_text(b.name+": ")})(h,a)}),b||this.reveal_pcs()},tadpole.Users.prototype.set_users=function(a){for(var b in a)this.remove_user(a[b].name,!0),this.set(a[b],!0);this.reveal_pcs()},tadpole.Users.prototype.remove_user=function(a,b){var c=this.ul.find("li.user#"+a);c&&c.remove(),b||this.reveal_pcs()},tadpole.Users.prototype.register=function(a,b){this.remove_user(a,!0);var c=this.manager.client.channel(this.id.split("-").slice(1).join(":")).info.members[a];if(!c){if(b)return;return void this.reveal_pcs()}this.set(c,b||!1)},tadpole.UsersArray=function(a,b,c,d,e,f){tadpole.MenuItemArray.call(this,a,b,c,d,e,f)},tadpole.UsersArray.prototype=new tadpole.MenuItemArray,tadpole.UsersArray.prototype.constructor=tadpole.UsersArray,tadpole.UsersArray.prototype.create_item=function(a,b){return new tadpole.Users(this.manager,this.menu,a,b)},tadpole.UsersArray.prototype.reveal=function(a,b){var c=this.item(a);c&&(c.overlay.reveal(),c.reveal(b))},tadpole.ChannelMenu=function(a,b){this.manager=a,this.parentview=b,this.menu=null,this.build()},tadpole.ChannelMenu.prototype.build=function(){this.menu=new tadpole.Menu(this.manager,this.parentview,"channels");var a=this;this.menu.add("back","exit","Channels",function(){a.hide()},"left-open")},tadpole.ChannelMenu.prototype.resize=function(){this.menu.resize()},tadpole.ChannelMenu.prototype.reveal=function(){return this.menu.reveal()},tadpole.ChannelMenu.prototype.hide=function(){return this.menu.hide()},tadpole.ChannelMenu.prototype.add=function(a,b,c){var d=this,e=this.menu.add("tab","tab-c-"+replaceAll(b,":","-"),a,function(){d.manager.book.reveal(b),d.manager.menu.toggle()},"",c);if("~"==a[0])return e;e.button.append('<span class="button right red close icon-cancel"></span>');var f=e.view.find(".button.close");return f.on("click",function(a){a.preventDefault(),a.stopPropagation(),d.manager.client.part(b)}),e},tadpole.Control=function(a){this.manager=a,this.build()},tadpole.Control.prototype.build=function(){this.manager.view.append('<div class="control"><form><input type="text" class="msg"></input></form></div>'),this.view=this.manager.view.find("div.control"),this.form=this.view.find("form"),this.input=this.view.find("input"),this.input.width(this.view.width()-20);var a=this;this.input.keydown(function(b){return a.keypress(b)}),this.form.submit(function(b){return a.submit(b)})},tadpole.Control.prototype.resize=function(){var a=this.view.width();this.input.width(a-20)},tadpole.Control.prototype.get_text=function(a){return void 0==a?this.input.val():(this.input.val(a||""),this.input.val())},tadpole.Control.prototype.set_text=function(a){this.input.val(a||"")},tadpole.Control.prototype.submit=function(a){var b=this.get_text();return this.set_text(""),this.handle(a,b),!1},tadpole.Control.prototype.keypress=function(a){var b=a.which||a.keyCode,c=!1;switch(b){case 13:a.shiftKey?this.submit(a):c=!0;break;default:c=!0}c||(a.preventDefault(),a.stopPropagation())},tadpole.Control.prototype.handle=function(a,b){if(""!=b&&this.manager.book.current){var c=!1;"/"!=b[0]&&(c=!0),b=(a.shiftKey?"/npmsg ":"/"==b[0]?"":"/say ")+b,b=b.slice(1);var d=b.split(" "),e=d.shift().toLowerCase(),f=this.manager.book.current.raw,g=f;if(!c&&d[0]){var h=d[0][0];("#"==h||"@"==h)&&d[0].length>1&&(g=this.manager.client.format_ns(d.shift()))}{var i=d.join(" ");this.manager.client.trigger("cmd."+e,{name:"cmd",cmd:e,args:i,target:g,ns:f})}}},tadpole.Book=function(a){this.manager=a,this.clist={},this.chans=[],this.current=null,this.build()},tadpole.Book.prototype.build=function(){this.manager.view.append('<div class="book"></div>'),this.view=this.manager.view.find("div.book");var a=$(window).height();this.view.height(a-80)},tadpole.Book.prototype.resize=function(){var a=$(window).height();this.view.height(a-80),this.current.scroll()},tadpole.Book.prototype.channel=function(a){var b=a.toLowerCase();for(var c in this.clist)if(this.clist.hasOwnProperty(c)&&c==b)return this.clist[c];return null},tadpole.Book.prototype.each=function(a,b){var c=null;b=b||!1;for(var d in this.clist)if(this.clist.hasOwnProperty(d)&&(c=this.clist[d],(!c.hidden||!b)&&a(d,c)))break},tadpole.Book.prototype.count=function(a){var b=-1;return this.each(function(){b++},a),b},tadpole.Book.prototype.add=function(a,b,c,d){this.remove(b);var e=new tadpole.Channel(a,b,c,d,this.manager,this);return this.clist[b.toLowerCase()]=e,this.chans.push(b.toLowerCase()),c||this.reveal(b),e},tadpole.Book.prototype.remove=function(a){var b=this.channel(a);if(b&&(0!=this.count(!0)||b.hidden)){var c=a.toLowerCase();b.remove(),delete this.clist[c],b==this.current&&this.reveal(this.previous()),this.chans.splice(this.chans.indexOf(c),1)}},tadpole.Book.prototype.reveal=function(a){var b=a.toLowerCase();this.clist.hasOwnProperty(b)&&(this.current&&this.current.hide(),this.current=this.clist[b],this.current.reveal(),this.manager.top.set_label(this.current.ns))},tadpole.Book.prototype.previous=function(){var a=this.current.raw,b=this.chans.indexOf(a.toLowerCase());if(0>b)return a;for(var c=null;;){try{c=this.channel(this.chans[--b])}catch(d){b=this.chans.length-1,c=this.channel(this.chans[b])}if(!c.hidden)break}return c.raw},tadpole.Book.prototype.next=function(){var a=this.current.raw,b=this.chans.indexOf(a.toLowerCase());if(0>b)return a;for(var c=null;;){try{c=this.channel(this.chans[++b])}catch(d){b=0,c=this.channel(this.chans[b])}if(!c.hidden)break}return c.raw},tadpole.Book.prototype.log=function(a){for(ns in this.clist)this.clist[ns].log(a)},tadpole.Book.prototype.log_message=function(a,b){var c=null;c=a.global?this.log(b):a.monitor?this.manager.log(b):this.channel(b.ns).log(b)},tadpole.Book.prototype.handle=function(a,b){var c=this.channel(a.ns);if(c){var d="pkt_"+a.name;try{c[d](a,b)}catch(e){}}},tadpole.Channel=function(a,b,c,d,e,f){this.manager=e,this.book=f,this.secret=c,this.tab=d.tab,this.head=d.head,this.users=d.users,this.ns=a,this.raw=b,this.selector="c-"+replaceAll(this.raw,":","-"),this.hidden=c||!1,this.visible=!1,this.tabc=0,this.build()},tadpole.Channel.prototype.build=function(){this.book.view.append('<div class="channel" id="'+this.selector+'"><ul class="log"></ul></div>'),this.view=this.book.view.find("div.channel#"+this.selector),this.logview=this.view.find("ul.log")},tadpole.Channel.prototype.remove=function(){this.view.remove(),this.tab.remove(),this.manager.menu.heads.remove(this.selector),this.manager.menu.users.remove(this.selector)},tadpole.Channel.prototype.scroll=function(){var a=this.view.prop("scrollHeight")-this.logview.innerHeight();0>a||a-this.view.scrollTop()>100||this.view.animate({scrollTop:this.view.prop("scrollHeight")},600)},tadpole.Channel.prototype.reveal=function(){this.visible||this.hidden||(this.view.css({display:"block"}),this.visible=!0,this.manager.top.set_label(this.ns),this.scroll(),this.unhighlight())},tadpole.Channel.prototype.hide=function(){this.visible&&(this.view.css({display:"none"}),this.visible=!1)},tadpole.Channel.prototype.log=function(a){var b=new Date,c=this,d=a.html;this.manager.cascade("ns.log",function(a){c.logview.append('<li id="'+a.ms+'"><span class="timestamp">'+a.ts+"</span>"+a.content+"</li>"),c.scroll();var b=c.logview.find("li#"+a.ms).last();c.manager.emit("ns.log.after",{channel:c,item:b,data:a,event:a.event})},{channel:this,date:b,ts:formatTime("{HH}:{mm}:{ss}",b),ms:b.getTime(),content:d,event:a})},tadpole.Channel.prototype.join=function(a){this.log('<p class="background"><strong class="event join">** '+a+" joined *</strong></p>")},tadpole.Channel.prototype.part=function(a,b){this.log('<p class="background"><strong class="event part">** '+a+" left *</strong> "+b+"</p>")},tadpole.Channel.prototype.message=function(a,b){var c=this.log('<h2 class="username">'+a+"</h2><p>"+b+"</p>");this.highlight(c,a,b)},tadpole.Channel.prototype.action=function(a,b){var c=this.log('<p><em><strong class="username">* '+a+"</strong> "+b+"</em></p>");this.highlight(c,a,b)},tadpole.Channel.prototype.highlight=function(){(!this.visible||this.ui.menu.menu.overlay.visible)&&(this.hidden||(this.tabc++,this.manager.top.tab(1),this.tab.highlight()))},tadpole.Channel.prototype.unhighlight=function(){this.manager.top.untab(this.tabc),this.tab.unhighlight(),this.tabc=0},tadpole.Channel.prototype.kick=function(a,b,c){this.log('<p><em><strong class="event kick">** '+a+" kicked by "+b+" *</strong> "+c+"</em></p>")},tadpole.Channel.prototype.pkt_property=function(a,b){var c=a.pkt.arg.p,d=b.channel(this.raw);switch(c){case"title":case"topic":this.head.set(c,a.value||new wsc.MessageString(""),a.by,a.ts);break;case"privclasses":this.users.set_pcs(d.info.pc,d.info.pc_order.slice(0));break;case"members":}},tadpole.Protocol=function(){this.messages={chatserver:{keys:["version"],template:"<h2>Connected to llama {version}</h2>",global:!0},dAmnServer:{keys:["version"],template:"<h2>Connected to dAmnServer {version}</h2>",global:!0},login:{keys:["username","e","data"],template:'<p><strong class="event">Login as {username}:</strong> "{e}"</p>',global:!0},join:{keys:["ns","e"],template:'<p><strong class="event">Join {ns}:</strong> "{e}"</p>',monitor:!0},part:{keys:["ns","e","r"],template:'<h2>Part {ns} "{e}"</h2><p>{r}</p>',monitor:!0},property:{keys:["ns","p","by","ts","value"],template:"<h2>Got {p} for {ns}</h2>",monitor:!0},recv_msg:{keys:["user","message"],template:'<h2 class="username">{user}</h2><p>{message}</p>'},recv_action:{keys:["s","user","message"],template:'<p><em><strong class="username">* {user}</strong> {message}</em></p>'},recv_join:{keys:["user","s","info"],template:'<h2 class="background">{user} joined</h2>'},recv_part:{keys:["user","r"],template:'<h2 class="background">{user} has left</h2><p class="background">{r}</p>'},recv_privchg:{keys:["user","s","by","pc"],template:"<p><strong><em>{user} has been made a member of {pc} by {by}</em></strong></p>"},recv_kicked:{keys:["user","s","by","r"],template:"<h2>{user} has been kicked by {by}</h2><p>{r}</p>"},recv_admin_create:{keys:["p","user","pc","privs"],template:"<h2>Privilege class {pc} has been created by {user}</h2><p>{privs}</p>"},recv_admin_update:{keys:["p","user","pc","privs"],template:"<h2>Privilege class {pc} has been updated by {user}</h2><p>{privs}</p>"},recv_admin_rename:{keys:["p","user","prev","pc"],template:"<h2>Privilege class {prev} has been renamed to {pc} by {user}</h2>"},recv_admin_move:{keys:["p","user","prev","pc","affected"],template:"<h2>All members of {prev} have been moved to {pc} by {user}</h2><p>{affected} affected user(s)</p>"},recv_admin_remove:{keys:["p","user","pc","affected"],template:"<h2>Privilege class {pc} has been removed by {user}</h2><p>{affected} affected user(s)</p>"},recv_admin_show:null,recv_admin_showverbose:null,recv_admin_privclass:{keys:["p","e","command"],template:'<h2>Admin command "{command}" failed</h2><p>{e}</p>'},kicked:{keys:["ns","user","r"],template:"<h2>You have been kicked by {user}</h2><p>{r}</p>"},ping:null,disconnect:{keys:["e"],template:"<h2>You have been disconnected</h2><p>{e}</p>",global:!0},send:{keys:["ns","e"],template:'<p><strong class="event">Send error: <em>{e}</em></p>'},kick:{keys:["ns","user","e"],template:"<h2>Could not kick {user}</h2><p>{e}</p>"},get:{keys:["ns","p","e"],template:"<h2>Could not get {p} info for {ns}</h2><p>{e}</p>"},set:{keys:["ns","p","e"],template:"<h2>Could not set {p}</h2><p>{e}</p>"},kill:{keys:["ns","e"],template:"<h2>Kill error</h2><p>{e}</p>"},log:{keys:["ns","msg","info"],template:"<h2>{msg}</h2><p>{info}</p>"},unknown:{keys:["ns","packet"],template:"<h2>Received unknown packet in {ns}</h2><p>{packet}</p>",monitor:!0}}
},tadpole.Protocol.prototype.extend_messages=function(a){for(var b in a)this.messages.hasOwnProperty(b)&&(this.messages[b]=a[b])},tadpole.Protocol.prototype.log=function(a){var b=this.messages[a.name];return new tadpole.Protocol.LogMessage(a,b)},tadpole.Protocol.LogMessage=function(a,b){b=b||{},this.event=a,this.template=b.template||"",this.keys=b.keys||[],this.monitor=b.monitor||!1,this.global=b.global||!1,this._html=!1,this._text=!1,this._ansi=!1},tadpole.Protocol.LogMessage.prototype.text=function(){return this._text===!1&&(this._text=this.render(0)),this._text},tadpole.Protocol.LogMessage.prototype.html=function(){return this._html===!1&&(this._html=this.render(1)),this._html},tadpole.Protocol.LogMessage.prototype.ansi=function(){return this._ansi===!1&&(this._ansi=this.render(2)),this._ansi},tadpole.Protocol.LogMessage.prototype.render=function(a){void 0===a&&(a=0);var b=this.template,c="";for(var d in this.keys)if(this.keys.hasOwnProperty(d)&&(key=this.keys[d],key instanceof Array&&(key=key[1]),"pkt"!=key&&(c=this.event[key]||"",null!=c))){if(("ns"==key||"sns"==key)&&(key="ns",c=this.event.sns||c),c.hasOwnProperty("_parser"))switch(a){case 1:c=c.html();break;case 2:c=c.ansi();break;case 0:default:c=c.text()}b=replaceAll(b,"{"+key+"}",c)}return b},tadpole.Commands=function(a,b){var c={},d={};c.away={},b.storage=a.storage.folder("tadpole"),c.storage=b.storage,d.theme=b.options.default_theme,c.save=function(){c.storage.set("theme",d.theme)},c.load=function(){d.theme=c.storage.get("theme",d.theme)},c.load();var e=function(){b.menu.commands.add("join","joinchannel","Join Channel",function(){f.reveal("joinchannel")}),c.away.button=b.menu.commands.add("away","away","Set Away",function(){return a.ext.defaults.away.on?(a.ext.defaults.away.back(),void c.away.button.button.text("Set Away")):void f.reveal("set-away")}),b.menu.commands.add("ignore","ignoreuser","Ignore User",function(){b.menu.show_users(function(c,d){a.ext.defaults.ignore.add(d.name,!0),b.menu.toggle()})}),b.menu.commands.add("kick","kickuser","Kick User",function(){b.menu.show_users(function(c,d){a.kick(b.book.current.raw,d.name),b.menu.toggle()})}),b.menu.commands.add("ban","banuser","Ban User",function(){b.menu.show_users(function(c,d){a.ban(b.book.current.raw,d.name),b.menu.toggle()})}),b.menu.settings.add("themes","Theme",function(){g.reveal("theme")}),b.menu.settings.add("aj","Autojoin",function(){h.update(),g.reveal("aj")}),b.menu.settings.add("ignore","Ignores",function(){i.update(),g.reveal("ignore")})},f=b.menu.commanditems,g=b.menu.settings.page;tadpole.Commands.JoinChannel(a,b,f);var h=tadpole.Commands.Autojoin(a,b,g),i=(tadpole.Commands.Away(a,b,f,c),tadpole.Commands.Ignore(a,b,g));return tadpole.Commands.Theme(a,b,g,c,d),e(),c},tadpole.Commands.Theme=function(a,b,c,d,e){d.theme={};var f=c.add("theme"),g=f.overlay.view,h={};g.append("<nav><ul></ul></nav>");var i=g.find("ul");new tadpole.MenuButton(i,"back","","Theme",function(){f.overlay.hide(),f.hide()},"left-open"),d.theme.add=function(a,c){b.options.themes.hasOwnProperty(a)||(b.options.themes[a]=c);var e=new tadpole.MenuButton(i,"theme",c,a,function(){d.theme.select(a)});h[a]=e},d.theme.deselect=function(a){h.hasOwnProperty(a)&&(h[a].unhighlight(),b.view.hasClass(b.options.themes[a])&&b.view.removeClass(b.options.themes[a]),e.theme="")},d.theme.select=function(a){h.hasOwnProperty(a)&&(d.theme.deselect(e.theme),h[a].highlight(),b.view.hasClass(b.options.themes[a])||b.view.addClass(b.options.themes[a]),e.theme=a,d.save())};for(var j in b.options.themes)b.options.themes.hasOwnProperty(j)&&d.theme.add(j,b.options.themes[j]);d.theme.select(e.theme)},tadpole.Commands.JoinChannel=function(a,b,c){var d=c.add("joinchannel"),e=d.overlay.view;e.append('<nav><ul><li><a href="#" class="button">  <span class="icon-left-open"></span>Join Channel  </a></li></ul></nav><div class="section border">  <p>Enter the name of a channel to join.</p>  <form><input class="join" type="text" /></form>  <p>Or tap a channel from the list below.</p></div><nav class="channels"><ul>  <li><a href="#" class="button cltitle">      <span class="icon-comment"></span>Channels</a></li></ul></nav>');{var f=e.find("nav ul li a.button"),g=e.find("input.join"),h=e.find("form"),i=e.find("nav.channels ul");i.find(".button.cltitle")}f.on("click",function(a){a.preventDefault(),a.stopPropagation(),d.overlay.hide()}),h.submit(function(d){d.preventDefault(),d.stopPropagation();var e=g.val();e=e.split(" ");for(var f in e)a.join(e[f]);c.hide("joinchannel"),b.menu.toggle(),g.val("")});var j=[],k={add:function(c){var d=new tadpole.MenuButton(i,"channel",replaceAll(a.format_ns(c.chatname),":","-"),c.chatname,function(){a.join(c.chatname),b.menu.toggle()});return d.button.append(' <span class="faint">'+c.usercount+' users</span><span class="button right green join icon-plus"></span><p>'+c.description+"</p>"),j.push(d),d},clear:function(){for(;j.length>0;)j.pop().remove()},update:function(){k.clear(),$.getJSON(window.location.origin+"/api/chat/channels",function(a){a=a.chats.slice(0,50);for(var b in a)k.add(a[b])}),setTimeout(k.update,33e4)}};k.update()},tadpole.Commands.Autojoin=function(a,b,c){var d=c.add("aj"),e=d.overlay.view;e.append('<nav><ul><li><a href="#" class="button back">  <span class="icon-left-open"></span>Autojoin  </a></li><li><a href="#" class="button switch off">  <span class="icon-cancel"></span>Off  </a></li></ul></nav><div class="section border">  <p>Add channels to your autojoin list.</p>  <form><input class="join" type="text" /></form></div><nav class="channels"><ul><li><a href="#" class="button ajtitle">  <span class="icon-comment"></span>Channels  </a></li></ul></nav>');var f={back:e.find(".button.back"),toggle:e.find(".button.switch"),ajtitle:e.find(".button.ajtitle")},g=e.find("form"),h=g.find("input"),i=e.find("nav.channels ul"),j=[];f.back.on("click",function(a){a.preventDefault(),a.stopPropagation(),d.overlay.hide()});var k=function(b){b.preventDefault(),b.stopPropagation(),a.ext.defaults.autojoin.on=!a.ext.defaults.autojoin.on,a.ext.defaults.autojoin.save(),l.update_toggle()};f.toggle.on("click",k),f.ajtitle.on("click",function(a){a.preventDefault(),a.stopPropagation()}),g.submit(function(b){b.preventDefault(),b.stopPropagation();var c=h.val();h.val(""),c=c.split(" ");for(var d in c)a.ext.defaults.autojoin.add(a.deform_ns(c[d]).toLowerCase());a.ext.defaults.autojoin.save(),l.update_list()});var l={add:function(b){var c=new tadpole.MenuButton(i,"channel",replaceAll(a.format_ns(b),":","-"),b,function(){});c.button.append('<span class="button right red close icon-cancel"></span>');var d=c.view.find(".button.close");return d.on("click",function(d){d.preventDefault(),d.stopPropagation(),a.ext.defaults.autojoin.remove(b),a.ext.defaults.autojoin.save(),c.remove()}),j.push(c),c},clear:function(){for(;j.length>0;)j.pop().remove()},update:function(){l.update_toggle(),l.update_list()},update_toggle:function(){f.toggle.html(a.ext.defaults.autojoin.on?'<span class="green icon-ok"></span>On <span class="faint">tap to turn off</span>':'<span class="red icon-cancel"></span>Off <span class="faint">tap to turn on</span>')},update_list:function(){l.clear();for(var b in a.ext.defaults.autojoin.channel)l.add(a.ext.defaults.autojoin.channel[b])}};return l.update(),l},tadpole.Commands.Away=function(a,b,c,d){var e=c.add("set-away"),f=e.overlay.view;f.append("<nav><ul></ul></nav>");var g=f.find("nav ul");new tadpole.MenuButton(g,"back","","Set Away",function(){e.overlay.hide(),e.hide()},"left-open"),new tadpole.MenuButton(g,"silent","","Silent Away",function(){a.ext.defaults.away.away(),d.away.button.button.text("Set Back"),b.menu.toggle()});var h=new tadpole.MenuButton(g,"awayr","","Reason",function(){});h.button.append('<p>Leave a message to show people who try and talk to you while you\'re away.</p><form><input class="reason" type="text" /></form>');var i=h.view.find("form"),j=i.find("input");i.submit(function(c){c.preventDefault(),c.stopPropagation();var e=j.val();a.ext.defaults.away.away(e),d.away.button.button.text("Set Back"),b.menu.toggle(),j.val("")})},tadpole.Commands.Ignore=function(a,b,c){var d=c.add("ignore"),e=d.overlay.view;e.append('<nav class="ignores"><ul></ul></nav>');var f=e.find("nav.ignores ul");new tadpole.MenuButton(f,"back","","Ignore",function(){d.overlay.hide(),d.hide()},"left-open");var g=new tadpole.MenuButton(f,"add","","Add User",function(){b.menu.show_users(function(c,d){a.ext.defaults.ignore.add(d.name,!0),b.menu.users.hide()})},"plus");g.button.append('<p>Select "Add User" or enter a username below.</p><form><input type="text" /></form>');var h=g.button.find("form"),i=h.find("input");new tadpole.MenuButton(f,"ilist","","Ignored Users",function(){},"user");var j=[];h.submit(function(b){b.preventDefault(),b.stopPropagation();var c=i.val();i.val(""),c=c.split(" ");for(var d in c)a.ext.defaults.ignore.add(c[d])}),h.on("click",function(a){a.preventDefault(),a.stopPropagation()});var k={add:function(b){var c=new tadpole.MenuButton(f,"user",b,b,function(){});c.button.append('<span class="button right red close icon-cancel"></span>');var d=c.view.find(".button.close");return d.on("click",function(c){c.preventDefault(),c.stopPropagation(),a.ext.defaults.ignore.remove(b)}),j.push(c),c},clear:function(){for(;j.length>0;)j.pop().remove()},update:function(){k.clear();for(var b in a.ext.defaults.ignore.ignored)k.add(a.ext.defaults.ignore.ignored[b])}};return k.update(),a.bind("ignore.load",k.update),a.bind("ignore.add",k.update),a.bind("ignore.remove",k.update),k},tadpole.SettingsMenu=function(a,b){this.manager=a,this.parentview=b,this.menu=null,this.page=null,this.build()},tadpole.SettingsMenu.prototype.build=function(){this.menu=new tadpole.Menu(this.manager,this.parentview,"settings"),this.page=new tadpole.MenuItemArray(this.manager,this.menu,this.manager.view,"settings","config");var a=this;this.add("exit","Settings",function(){a.hide()},"left-open")},tadpole.SettingsMenu.prototype.resize=function(){this.menu.resize()},tadpole.SettingsMenu.prototype.reveal=function(){return this.menu.reveal()},tadpole.SettingsMenu.prototype.hide=function(){return this.page.hide(),this.menu.hide()},tadpole.SettingsMenu.prototype.add=function(a,b,c,d,e){var f=this.menu.add("settings",a,b,function(a){c(a)},d,e);return f};